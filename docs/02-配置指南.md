# 配置指南

所有配置位于 `config/config.yaml`，这是系统的核心配置文件。

## 系统配置 (system)

```yaml
system:
  debug: false           # 调试模式（开发用）
  log_level: INFO        # 日志级别: DEBUG | INFO | WARNING | ERROR
  data_dir: ./data       # 数据目录（别动，没做兼容）
  cache_dir: ./data/cache  # 缓存目录
```

**建议**：生产环境用 `INFO`，排查问题时用 `DEBUG`。

---

## 服务器配置 (server)

```yaml
server:
  host: "0.0.0.0"  # 监听地址（0.0.0.0 表示所有网卡）
  port: 8082       # 监听端口（接收 NapCat WebSocket 反向连接）
  workers: 4       # 工作进程数（暂未使用）
```

**重要**：`port` 必须与 NapCat 配置中的 `ws.port` 保持一致！

---

## Web 后台配置 (web)

```yaml
web:
  enabled: true          # 是否启用 Web 管理后台
  host: "0.0.0.0"
  port: 8083             # Web 服务端口
  
  # JWT 认证配置
  jwt_secret_key: "change-this-secret"  # 务必修改！
  jwt_algorithm: "HS256"
  access_token_expires_minutes: 720     # Token 过期时间（分钟）
  
  # CORS 跨域配置
  frontend_origin: ""                   # 前端地址（如 http://localhost:5173）
  cors_allow_origins: ["*"]             # 允许的来源
  cors_allow_credentials: true
  
  # API 限流配置
  rate_limit:
    enabled: false       # 是否启用限流
    default: "120/minute"
    login: "10/minute"
    register_invite: "5/hour"
```

**安全提示**：
- 生产环境必须修改 `jwt_secret_key` 为复杂字符串
- 建议启用 `rate_limit` 防止滥用
- `cors_allow_origins` 在生产环境不要用 `["*"]`，指定具体域名

---

## 数据库配置 (database)

```yaml
database:
  type: sqlite
  url: sqlite+aiosqlite:///./data/graffito.db
  pool_size: 10
```

默认使用 SQLite，单机够用。如需高并发可换 PostgreSQL/MySQL。

---

## 缓存配置 (cache)

```yaml
cache:
  backend: "memory"      # 缓存后端: memory | redis | memcached
  serializer: "json"     # 序列化器: null | string | json | pickle | msgpack
  namespace: "graffito"  # 键前缀（多项目隔离用）
  ttl: 300               # 默认过期时间（秒）
  timeout: 5             # 操作超时（秒）
  
  # Redis 配置（当 backend=redis 时生效）
  redis_endpoint: "127.0.0.1"
  redis_port: 6379
  redis_db: 0
  redis_password: null
  redis_pool_size: 50
  
  # 业务配置
  message_cache_ttl: 7200  # 消息缓存 2 小时
  lock_timeout: 30         # 分布式锁超时
```

**选择建议**：
- 单机部署：用 `memory`，简单够用
- 分布式/生产：用 `redis`，支持跨实例共享

---

## LLM 配置 (llm)

```yaml
llm:
  base_url: https://api.openai.com/v1  # API 地址
  api_key: sk-your-api-key-here        # API 密钥
  text_model: gpt-4o-mini              # 文本处理模型
  vision_model: gpt-4o-mini            # 图片识别模型
  timeout: 30                          # 请求超时（秒）
  max_retry: 3                         # 最大重试次数
```

**使用环境变量**：
```yaml
api_key: ${OPENAI_API_KEY}  # 从环境变量读取
```

**代理示例**：
```yaml
base_url: https://api.example.com/v1  # 第三方 OpenAI 兼容服务
```

---

## 处理配置 (processing)

```yaml
processing:
  wait_time: 120         # 等待用户补充消息的时间（秒）
  max_concurrent: 10     # 最大并发处理数
```

`wait_time` 控制消息合并窗口：用户发送多条消息时，系统会等待 120 秒再统一处理。

---

## 渲染配置 (rendering)

```yaml
rendering:
  # 字体配置（支持自定义字体回退）
  font_family: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif"
  
  # 渲染后端: local | remote | cloudflare
  backend: local
  
  backend_config:
    # Remote 渲染服务配置（backend=remote 时）
    service_url: "http://localhost:8084"
    # token: "your_token"
    
    # Cloudflare 配置（backend=cloudflare 时）
    # account_id: "your_account_id"
    # api_token: "your_api_token"
  
  # 静态资源 URL
  static_base_url: "file://./static"  # 本地路径
  # static_base_url: "https://cdn.example.com/static"  # 远程 CDN
```

**渲染后端选择**：
- **local**: 本地 Playwright 渲染（推荐，安装简单）
- **remote**: 独立渲染服务（多实例共享时用）
- **cloudflare**: Cloudflare Browser Rendering（云端渲染，需要账号）

**独立渲染服务启动**：
```bash
# Windows
render.bat

# Linux/macOS
./render.sh
```

---

## 队列配置 (queue)

```yaml
queue:
  backend: AsyncSQLiteQueue  # AsyncSQLiteQueue | AsyncQueue | MySQLQueue | RedisQueue
  path: data/queues          # 本地队列目录（Async* 后端）
  serializer: pickle         # pickle | json | msgpack | cbor2
  
  # MySQL 配置（MySQLQueue 后端）
  mysql:
    host: 127.0.0.1
    port: 3306
    user: root
    password: ""
    database: graffito_queue
```

**推荐配置**：
- 单机：`AsyncSQLiteQueue`（默认）
- 分布式：`RedisQueue`（需配置 cache.backend=redis）

---

## QQ 接收器配置 (receivers.qq)

```yaml
receivers:
  qq:
    enabled: true                    # 是否启用
    auto_accept_friend: true         # 自动通过好友请求
    friend_request_window: 300       # 好友请求有效期（秒）
    friend_accept_delay_min: 180     # 通过延迟最小值（秒）
    friend_accept_delay_max: 240     # 通过延迟最大值（秒）
    access_token: ""                 # OneBot v11 鉴权令牌（可选）
```

**说明**：
- `auto_accept_friend`: 开启后自动通过好友请求
- `friend_accept_delay_*`: 随机延迟，模拟人工操作，防止被检测

---

## 发布器配置 (publishers)

### QQ 空间 (qzone)

```yaml
publishers:
  qzone:
    enabled: true              # 是否启用
    max_attempts: 3            # 失败重试次数
    batch_size: 30             # 批量发布数量
    max_images_per_post: 9     # 单条最多图片数
    send_schedule: []          # 定时发布时间（如 ["09:00", "18:00"]）
    
    # 发布控制
    publish_text: true         # 是否发布文本
    include_publish_id: true   # 是否包含编号
    include_at_sender: true    # 是否 @ 投稿者
    image_source: both         # rendered | chat | both
    include_segments: false    # 是否包含聊天分段文本
```

### B站 (bilibili)

```yaml
publishers:
  bilibili:
    enabled: false             # 是否启用
    max_attempts: 3
    batch_size: 30
    max_images_per_post: 9
    send_schedule: []
    
    publish_text: true
    include_publish_id: true
    include_at_sender: false   # B站 @ 需要 UID，默认关闭
    image_source: rendered
    include_segments: false
    
    # 账号配置
    accounts: {}
    # accounts:
    #   main:
    #     cookie_file: data/cookies/bilibili_main.json
```

**获取 Cookie**：运行 `python bilibili_login_tool.py`

### 小红书 (rednote)

```yaml
publishers:
  rednote:
    enabled: false
    max_attempts: 3
    batch_size: 20
    max_images_per_post: 9
    send_schedule: []
    
    publish_text: true
    include_publish_id: false  # 小红书建议关闭编号
    include_at_sender: false
    image_source: rendered
    include_segments: false
    
    accounts: {}
    
    # Playwright 配置
    headless: true             # 无头模式
    slow_mo_ms: 0              # 操作延迟（调试用）
    user_agent: ""             # 自定义 UA
```

**获取 Cookie**：运行 `python rednote_login_tool.py`

---

## 审核配置 (audit)

```yaml
audit:
  auto_approve: false          # 是否自动通过（不推荐）
  ai_safety_check: true        # AI 安全检测
  sensitive_words: []          # 敏感词列表
  skip_image_audit_over_mb: 0  # 跳过大图审核（MB，0=不跳过）
```

---

## Chisel 举报审核配置 (chisel)

```yaml
chisel:
  enable: true                 # 是否启用举报功能
  auto_delete: true            # 自动删除 danger 级别
  auto_pass: true              # 自动通过 safe 级别
  fetch_comments: true         # 抓取平台评论供 AI 分析
  comment_fetch_limit: 50      # 最多抓取评论数
```

---

## 账号组配置 (account_groups)

```yaml
account_groups:
  default:                     # 组名（可多个）
    name: "默认组"
    manage_group_id: "123456789"  # 管理群 QQ 号
    
    main_account:
      qq_id: "987654321"       # 主账号 QQ
      http_host: "127.0.0.1"   # NapCat 地址
      http_port: 3000          # NapCat HTTP 端口
      http_token: ""           # NapCat HTTP Token（可选）
    
    minor_accounts: []         # 副账号列表（暂未使用）
    
    max_post_stack: 1          # 最大堆叠投稿数
    watermark_text: ""         # 水印文本
    wall_mark: "Graffito"      # 墙标识（显示在渲染图底部）
    
    friend_add_message: "你好，欢迎投稿"
    
    quick_replies:             # 快捷回复
      "格式": "投稿格式：直接发送文字+图片即可"
      "时间": "我们会在每天9:00、12:00、18:00、21:00发送投稿"
    
    allow_anonymous_comment: true  # 允许匿名评论
```

**多账号组示例**：
```yaml
account_groups:
  tech_wall:
    name: "技术墙"
    manage_group_id: "111111111"
    main_account:
      qq_id: "222222222"
      http_host: "127.0.0.1"
      http_port: 3000
    wall_mark: "科技校园墙"
  
  life_wall:
    name: "生活墙"
    manage_group_id: "333333333"
    main_account:
      qq_id: "444444444"
      http_host: "127.0.0.1"
      http_port: 3001
    wall_mark: "生活校园墙"
```

---

## 下一步

- 查看 [使用指南](./03-使用指南.md) 了解如何使用系统


# 使用指南

## 用户投稿流程

### 1. 添加机器人好友

用户添加 QQ 机器人为好友后：
- 如果开启 `auto_accept_friend`，系统会在 3-4 分钟后自动通过（模拟人工延迟）
- 通过后会发送欢迎消息（`friend_add_message` 配置项）

### 2. 发送投稿

用户私聊机器人，直接发送内容即可：

**示例**：
```
今天食堂的饭真好吃！
[图片]
```

**多条消息合并**：
用户可以分多次发送，系统会在 2 分钟内（`processing.wait_time`）等待并自动合并。

```
用户第1条: 今天天气真好
用户第2条: [图片1]
用户第3条: [图片2]
用户第4条: 大家快去操场玩！

→ 系统等待 2 分钟 → 合并处理
```

### 3. 等待处理

系统收到投稿后：

1. **消息确认**
   ```
   🎉 收到你的投稿！
   ⏰ 投稿编号: #1234
   
   我们的 AI 正在审核中，请耐心等待...
   ```

2. **AI 安全检测**
   - 文本内容安全性检查
   - 图片内容识别与描述
   - 敏感词过滤
   - 自动判断是否匿名

3. **内容渲染**
   - 将投稿渲染为精美图片
   - 添加墙标识和水印

4. **转发至管理群**
   
   投稿会自动转发到管理群，包含：
   - 投稿内容
   - 渲染后的图片
   - AI 审核结果
   - 操作按钮

### 4. 审核结果通知

- **通过**：
  ```
  ✅ 你的投稿已通过审核！
  📝 投稿编号: #1234
  ⏰ 预计在 18:00 发布到各平台
  ```

- **拒绝**：
  ```
  ❌ 很抱歉，你的投稿未通过审核
  📝 投稿编号: #1234
  💬 原因: [管理员填写的原因]
  ```

---

## 管理员审核操作

### 群聊指令（快捷）

管理员在管理群中回复投稿消息，使用以下指令：

| 指令 | 说明 | 示例 |
|------|------|------|
| `是` / `通过` / `y` | 通过投稿 | 是 |
| `否` / `拒绝` / `n` | 拒绝投稿（不通知） | 否 |
| `拒 [原因]` | 拒绝并通知原因 | 拒 内容不符合规范 |
| `匿` / `匿名` | 切换匿名状态 | 匿 |
| `删` / `删除` | 删除投稿 | 删 |
| `立即` / `立即发布` | 立即发布（忽略定时） | 立即 |
| `重渲染` | 重新渲染图片 | 重渲染 |
| `评论 [内容]` | 添加评论到平台 | 评论 感谢投稿！ |
| `回复 [内容]` | 回复投稿者 | 回复 请补充更多细节 |
| `拉黑` / `黑名单` | 拉黑投稿者 | 拉黑 |

**使用方式**：
1. 找到管理群中转发的投稿消息
2. 直接回复该消息
3. 发送指令

**示例对话**：
```
[机器人转发投稿]
📮 新投稿 #1234
👤 投稿者: 匿名
📝 内容: 今天天气真好
[渲染图片]
🤖 AI审核: 安全 ✅

[管理员回复]
是

[机器人反馈]
✅ 投稿 #1234 已通过审核
```

### Web 管理后台

访问 `http://your_server_ip:8083`（默认端口 8083）

#### 首次登录

1. **初始化超级管理员**
   
   首次访问时，点击"初始化超级管理员"：
   - 输入用户名和密码
   - 系统自动创建第一个管理员账号

2. **创建邀请链接**
   
   超级管理员登录后：
   - 进入"用户管理"
   - 点击"创建邀请链接"
   - 将链接发送给其他管理员

3. **邀请注册**
   
   其他管理员通过邀请链接注册账号

#### 审核投稿

Web 后台提供更丰富的审核功能：

1. **投稿列表**
   - 查看所有待审核投稿
   - 按状态筛选（待审核/已通过/已拒绝/已发布）
   - 搜索投稿编号或内容

2. **投稿详情**
   - 查看完整投稿内容
   - 预览渲染图片
   - 查看 AI 审核结果
   - 查看投稿者信息（如果非匿名）

3. **审核操作**
   - 通过/拒绝/删除
   - 修改匿名状态
   - 添加评论
   - 立即发布

4. **数据统计**
   - 投稿总数
   - 通过率
   - 平台发布成功率

---

## 投稿者操作指令

投稿者在私聊机器人时可使用以下指令：

### #评论 - 追加评论

对已发布的投稿追加评论：

```
#评论 [投稿编号] [评论内容]
```

**示例**：
```
#评论 #1234 补充一下：今天还看到了彩虹！
```

**说明**：
- 仅投稿者本人可评论自己的投稿
- 评论会同步到所有已发布的平台
- 如果 `allow_anonymous_comment: true`，评论者身份不会暴露

### #举报 - 举报违规内容

举报已发布的违规投稿：

```
#举报 [投稿编号] [举报理由]
```

**示例**：
```
#举报 #1234 内容涉及人身攻击
```

**处理流程**：
1. AI 自动分析举报内容，评级（safe/warning/danger）
2. 如果配置了 `chisel.auto_delete: true`，danger 级别自动删除
3. warning 级别进入人工审核
4. safe 级别自动驳回（如果 `chisel.auto_pass: true`）

---

## 定时发布

### 配置定时任务

在发布器配置中设置 `send_schedule`：

```yaml
publishers:
  qzone:
    send_schedule: ["09:00", "12:00", "18:00", "21:00"]
```

系统会在每天的 9:00、12:00、18:00、21:00 自动发布所有待发布的投稿。

### 批量发布

每次定时发布会批量处理 `batch_size` 个投稿：

```yaml
publishers:
  qzone:
    batch_size: 30  # 每次最多发布 30 条
```

如果待发布投稿超过 30 条，会在下次定时任务继续发布。

### 立即发布

管理员可以跳过定时，立即发布某条投稿：

**群聊指令**：
```
[回复投稿消息]
立即
```

**Web 后台**：
点击投稿详情页的"立即发布"按钮

---

## Chisel 举报系统

### 用户举报

任何用户都可以举报已发布的投稿：

```
#举报 #1234 内容不实
```

### AI 风险评级

系统收到举报后，AI 会自动评估：

- **safe**（安全）：
  - 举报理由不成立
  - 投稿内容正常
  - 如果 `auto_pass: true`，自动驳回举报

- **warning**（警告）：
  - 疑似违规，需要人工判断
  - 转发到管理群人工审核

- **danger**（危险）：
  - 确实违规，建议删除
  - 如果 `auto_delete: true`，自动删除并通知各方

### 管理员复核

warning 级别的举报会转发到管理群：

```
🚨 新举报 #5678
📮 投稿编号: #1234
👤 举报者: [匿名]
💬 举报理由: 内容不实
🤖 AI 评级: ⚠️ warning

[投稿内容预览]
[平台评论摘要]

请管理员决定：
- 删除投稿
- 驳回举报
```

管理员回复：
- `删` / `删除` - 删除投稿
- `否` / `驳回` - 驳回举报

### 评论分析

如果配置 `fetch_comments: true`，AI 会抓取平台评论并分析舆情：

```yaml
chisel:
  fetch_comments: true
  comment_fetch_limit: 50  # 最多抓取 50 条评论
```

AI 会综合分析：
- 举报理由
- 投稿内容
- 平台评论舆情

给出更准确的风险评级。

---

## 多平台发布

### 启用平台

在 `config.yaml` 中启用需要的平台：

```yaml
publishers:
  qzone:
    enabled: true   # 启用 QQ 空间
  
  bilibili:
    enabled: true   # 启用 B 站
  
  rednote:
    enabled: false  # 禁用小红书
```

### 平台登录

每个平台都需要登录获取 Cookie：

**QQ 空间**：
- 使用 `aioqzone` 自动登录
- 首次发布时会生成二维码，扫码登录
- Cookie 自动保存到 `data/cookies/qzone_{qq_id}.json`

**B 站**：
```bash
python bilibili_login_tool.py
```
- 选择登录方式（扫码/短信/密码/导入 Cookie）
- Cookie 保存到 `data/cookies/bilibili_{account_id}.json`

**小红书**：
```bash
python rednote_login_tool.py
```
- 选择登录方式（扫码/导入 Cookie）
- Cookie 保存到 `data/cookies/rednote_{account_id}.json`

### 平台发布配置

每个平台可以独立配置发布格式：

```yaml
publishers:
  qzone:
    publish_text: true         # 发布文本
    include_publish_id: true   # 包含编号（#1234）
    include_at_sender: true    # @ 投稿者（如果非匿名）
    image_source: both         # 图片来源（rendered/chat/both）
    include_segments: false    # 包含聊天记录分段文本
```

**image_source 说明**：
- `rendered`: 仅使用渲染后的精美图片
- `chat`: 仅使用投稿时的原始聊天图片
- `both`: 两者都包含（渲染图在前）

**include_segments 说明**：
- `true`: 在文本中包含投稿的聊天分段内容
- `false`: 仅发布渲染图，不包含原始文字

**推荐配置**：
- QQ 空间：`image_source: both`（展示渲染图 + 原图）
- B 站：`image_source: rendered`（仅精美图片）
- 小红书：`image_source: rendered`（仅精美图片）

---


